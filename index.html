<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kartonowy Nape≈Çniacz ‚Äî v0.007r</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0e1117; --panel:#121826; --panel2:#0f1624; --text:#e5e7eb; --muted:#93a4b5; --accent:#22c55e; --line:#1f2937; --yellow:#fde047; }
    body{margin:0;background:linear-gradient(180deg,var(--panel),var(--panel2));color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:auto;padding:12px 16px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    .body{padding:10px 14px}
    .badge{font-size:12px;color:#cbd5e1;background:#0b1220;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
    .btn{border:1px solid var(--line);background:#0b1220;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0d3b2c;border-color:#184c39}
    .btn.ghost{background:transparent}
    .machines{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.machines{grid-template-columns:1fr 1fr}}
    .machine .title{display:flex;align-items:center;gap:10px}
    .machine .title h2{margin:0;font-size:26px;letter-spacing:.3px}
    .meta{color:var(--muted);font-size:12px;margin:6px 0}
    .progress{margin-top:6px;height:18px;border:1px solid var(--line);border-radius:12px;background:#0b1220;position:relative;overflow:hidden}
    .progress .bar{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#22c55e,#86efac);transition:width .25s ease}
    .progress .label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:12px}
    /* Pr√ºfung bigger + themed select with yellow text */
    .pruef{margin-top:10px}
    .pr-head{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .pr-head select.pr-select{background:var(--panel2);border:1px solid var(--line);color:var(--yellow);padding:8px 10px;border-radius:10px}
    .pr-bar{position:relative;height:68px;border:1px solid var(--line);border-radius:14px;background:#0b1220;overflow:hidden}
    .pr-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,#22c55e,#84cc16);transition:width .5s linear}
    .pr-label{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px}
    .pr-reset{position:absolute;right:10px;top:50%;transform:translateY(-50%);border:1px solid var(--line);background:var(--panel2);border-radius:8px;padding:4px 8px;cursor:pointer}
    /* Notes & Plans */
    .notes-list .row{display:flex;gap:10px;align-items:flex-start;border-bottom:1px dashed #263446;padding:8px 0}
    .stamp{display:inline-flex;gap:6px;align-items:center}
    .stamp .chip{background:#0b1220;border:1px solid #263446;border-radius:999px;padding:2px 6px}
    .stamp .small{font-size:12px;color:#9aa8b6}
    .stamp .digits{font-variant-numeric:tabular-nums;letter-spacing:.2px}
    .notes-list .txt{flex:1}
    .notes-list .act{display:flex;gap:6px}
    .tag{display:inline-block;margin-left:6px;font-size:12px;padding:2px 6px;border-radius:999px;border:1px solid #3b4760}
    .tag.draft{color:#eab308;border-color:#a16207;background:#2a2208}
    /* Chat stream */
    .alerts{display:flex;flex-wrap:wrap;gap:8px}
    .alert{display:flex;gap:8px;align-items:center;border:1px solid #2e3b53;border-radius:10px;padding:6px 10px;background:#0b1220}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="panel">
      <div class="head">
        <div class="loginbar flex items-center gap-2">
          <strong id="loginName">Zalogowany jako: Kamil Kowalczyk</strong> <small id="loginId">(SoG1917)</small>
          <select id="loginSelect" class="btn">
            <option value="SoG1917|Kamil Kowalczyk">Kamil Kowalczyk (SoG1917)</option>
            <option value="SoG1|Michael Scott">Michael Scott (SoG1)</option>
            <option value="SoG1899|James Corden">James Corden (SoG1899)</option>
            <option value="SoP1|Piotr Nowak">Piotr Nowak (SoP1)</option>
          </select>
          <button id="loginBtn" class="btn">üîê Zmie≈Ñ</button>
        </div>
        <div class="badge">v0.007r</div>
      </div>
      <div class="body">
        <h1 class="m-0">üè≠ Kartonowy Nape≈Çniacz <span class="text-xs opacity-70">(pure HTML)</span></h1>
        <div id="statusLine" class="opacity-80 mt-1">Status: gotowy</div>
        <div id="chatStream" class="alerts mt-2"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="machines" class="machines"></section>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0">üóíÔ∏è Notatki</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="noteInput" class="btn" style="flex:1" placeholder="Wpisz notatkƒô‚Ä¶ (SoG1917: bƒôdzie pro≈õba o kod 0..1000)">
          <button id="addNote" class="btn primary">+ Dodaj</button>
        </div>
        <div id="notesList" class="notes-list mt-2"></div>
      </div>
    </section>

    <section class="panel mt-3">
      <div class="head"><h2 class="m-0">üìå Dalsze plany</h2></div>
      <div class="body">
        <div class="flex gap-2 flex-wrap">
          <input id="planInput" class="btn" style="flex:1" placeholder="Nowy pomys≈Ç / zadanie‚Ä¶">
          <button id="addPlan" class="btn">+ Dodaj plan</button>
          <button id="refreshNP" class="btn ghost">‚Üª Od≈õwie≈º z MySQL</button>
        </div>
        <div id="plansList" class="notes-list mt-2"></div>
      </div>
    </section>
  </main>

  <template id="tpl-machine">
    <article class="panel machine">
      <div class="head">
        <div class="title"><span>ü§ñ</span><h2 class="code"></h2></div>
      </div>
      <div class="body">
        <div class="meta">
          <div>Auftrag: <span class="auf-val">‚Äî</span></div>
          <div>Model: <span class="mdl-val">‚Äî</span></div>
          <div>Okres: <span class="period-val">‚Äî</span></div>
          <div>Nastƒôpny Auftrag: <span class="nextauf-val">‚Äî</span></div>
        </div>

        <div class="progress"><div class="bar"></div><div class="label">0%</div></div>

        <div class="pruef">
          <div class="pr-head">üß™ Pr√ºfung ‚Äî czas:
            <select class="pr-select">
              <option value="3600">1h</option>
              <option value="7200">2h</option>
              <option value="10800">3h</option>
              <option value="custom">rƒôcznie‚Ä¶</option>
            </select>
          </div>
          <div class="pr-bar">
            <div class="pr-fill"></div><div class="pr-label">60:00</div><div class="pr-reset">Reset</div>
          </div>
        </div>
      </div>
    </article>
  </template>

  <script>
    // --- basic state
    const ORDERS_KEY='KN_ORDERS_V1';
    const NOTES_KEY='KN007_NOTES';
    const PLANS_KEY='KN007_PLANS';
    const ADMIN_PASS = 123; // kod 0..1000 wymagany do publikacji SoG1917

    const DEFAULTS={
      user:{uid:'SoG1917', name:'Kamil Kowalczyk'},
      machines:[
        { code:'MA820061', durationMin:25, pruef:3600 },
        { code:'M820062',  durationMin:22, pruef:3600 },
        { code:'MA820063', durationMin:25, pruef:3600 },
        { code:'MA820064', durationMin:25, pruef:3600 },
      ],
      orders:{},
    };
    let CFG=JSON.parse(localStorage.getItem('KN007_CFG')||'null')||DEFAULTS;
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const isAdmin=()=> CFG.user?.uid==='SoG1917';
    function persist(){ localStorage.setItem('KN007_CFG', JSON.stringify(CFG)); }
    function setStatus(t){ $('#statusLine').textContent='Status: '+t; }

    // --- kv storage via php
    async function saveShared(key,json){ try{ const res=await fetch('storage.php?a=set&key='+encodeURIComponent(key),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(json)}); const j=await res.json(); return !!j.ok; }catch(e){ console.error(e); return false; } }
    async function loadShared(key){ try{ const res=await fetch('storage.php?a=get&key='+encodeURIComponent(key)); const j=await res.json(); return j.v?JSON.parse(j.v):null; }catch(e){ console.error(e); return null; } }

    // --- machines (minimal for 0.007 look)
    class Pruefung{ constructor(root){ this.root=root; this.fill=$('.pr-fill',root); this.label=$('.pr-label',root); this.sel=$('.pr-select',root); this.reset=$('.pr-reset',root);
        this.total=3600; this.start=Date.now(); this.bind(); this.tick(); }
      bind(){ this.sel.addEventListener('change',()=>{ const v=this.sel.value; if(v==='custom'){ const m=prompt('Minuty:', '60'); this.total=Math.max(60,(parseInt(m,10)||60)*60); } else { this.total=parseInt(v,10); } this.start=Date.now(); });
        this.reset.addEventListener('click',()=>{ this.start=Date.now(); }); }
      tick(){ const el=Math.min(this.total, Math.floor((Date.now()-this.start)/1000)); const left=this.total-el; const pct=Math.floor(el/this.total*100);
        this.fill.style.width=pct+'%'; const mm=String(Math.floor(left/60)).padStart(2,'0'), ss=String(left%60).padStart(2,'0'); this.label.textContent=`${mm}:${ss}`;
        requestAnimationFrame(()=>this.tick()); }
    }

    class Machine{ constructor(container,data,orders){ this.root=$('#tpl-machine').content.firstElementChild.cloneNode(true);
        this.code=data.code; $('.code',this.root).textContent=this.code;
        const o=orders[this.code]||genOrder(); $('.auf-val',this.root).textContent=o.auftrag; $('.mdl-val',this.root).textContent=o.model; $('.period-val',this.root).textContent=o.period; $('.nextauf-val',this.root).textContent=o.next||'‚Äî';
        this.bar=$('.bar',this.root); this.label=$('.label',this.root);
        container.appendChild(this.root); this.pr=new Pruefung($('.pruef',this.root));
        // simple progress demo
        let start=performance.now(), dur=(data.durationMin||25)*60000; const step=()=>{ const p=Math.min(1,(performance.now()-start)/dur); this.bar.style.width=(p*100)+'%'; this.label.textContent=Math.floor(p*100)+'%'; requestAnimationFrame(step) }; requestAnimationFrame(step);
    } }

    function genOrder(){ const rnd=String(Math.floor(Math.random()*10000)).padStart(4,'0'); const s=new Date(); const e=new Date(); e.setDate(s.getDate()+5);
      const F=d=>`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
      return { auftrag:'1012'+rnd, model:'DASG-1 (201044)', period:`od ${F(s)} do ${F(e)}`, next:'' };
    }

    function renderMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    // --- stamps
    function makeStamp(ts,user,smaller=false){
      const d=new Date(ts);
      const dd=String(d.getDate()).padStart(2,'0'), mm=String(d.getMonth()+1).padStart(2,'0'), yyyy=d.getFullYear();
      const hh=String(d.getHours()).padStart(2,'0'), min=String(d.getMinutes()).padStart(2,'0');
      const small=smaller?' small':'';
      return `<span class="stamp">
        <span class="chip small digits${small}">[${dd}/${mm}/${yyyy}]</span>
        <span class="chip small digits${small}">[${hh}:${min}]</span>
        <span class="chip small">${user.uid} (${user.name})</span>
      </span>`;
    }

    // --- chat stream
    function chatPush(text){ const el=document.createElement('div'); el.className='alert'; el.innerHTML=`<span>üí¨ ${text}</span> <button class="btn ghost">‚úñ</button>`; $('.btn',el).onclick=()=>el.remove(); $('#chatStream').prepend(el); }

    // --- notes / plans
    let NOTES=[], PLANS=[];
    function renderNotes(){
      const list=$('#notesList'); list.innerHTML='';
      NOTES.forEach(n=>{
        const row=document.createElement('div'); row.className='row';
        const tag = n.status==='DRAFT' ? '<span class="tag draft">DRAFT</span>' : '';
        row.innerHTML=`<div class="meta">${makeStamp(n.ts, {uid:n.user,name:n.userName})} ${tag}</div>
                       <div class="txt">${n.text}</div>
                       <div class="act"></div>`;
        const act=$('.act',row);
        if(isAdmin()){
          const bE=document.createElement('button'); bE.className='btn'; bE.textContent='‚úèÔ∏è'; bE.title='Edytuj';
          const bR=document.createElement('button'); bR.className='btn'; bR.textContent='‚Ü©Ô∏è'; bR.title='Odpowiedz';
          const bD=document.createElement('button'); bD.className='btn'; bD.textContent='üóëÔ∏è'; bD.title='Usu≈Ñ';
          bE.onclick=async()=>{ const v=prompt('Edytuj notatkƒô', n.text); if(v!=null){ n.text=v; await saveNotes(); renderNotes(); } };
          bR.onclick=async()=>{ const v=prompt('Odpowied≈∫', ''); if(v){ NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:`‚Ü™ ${v} (odpowied≈∫ na #${n.id})`, status:'FINAL'}); await saveNotes(); renderNotes(); } };
          bD.onclick=async()=>{ if(confirm('UsunƒÖƒá notatkƒô?')){ NOTES = NOTES.filter(x=>x.id!==n.id); await saveNotes(); renderNotes(); } };
          act.append(bE,bR,bD);
        }
        list.appendChild(row);
      });
    }
    function renderPlans(){
      const list=$('#plansList'); list.innerHTML='';
      PLANS.forEach(p=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div class="meta">${makeStamp(p.ts, {uid:p.user,name:p.userName}, true)}</div>
                       <div class="txt">${p.text}</div>`;
        list.appendChild(row);
      });
    }
    async function saveNotes(){ await saveShared(NOTES_KEY, NOTES); }
    async function loadNotes(){ const db=await loadShared(NOTES_KEY); if(db){ NOTES=db; } renderNotes(); }
    async function savePlans(){ await saveShared(PLANS_KEY, PLANS); }
    async function loadPlans(){ const db=await loadShared(PLANS_KEY); if(db){ PLANS=db; } renderPlans(); }

    // --- login
    function showUser(){ $('#loginName').textContent='Zalogowany jako: '+(CFG.user?.name||'nieznany'); $('#loginId').textContent=CFG.user?.uid?`(${CFG.user.uid})`:'(nieznany)'; }
    function initLogin(){
      showUser();
      $('#loginBtn').onclick=()=>{
        const sel=$('#loginSelect').value; const [uid,name]=sel.split('|');
        const pass=prompt(`Has≈Ço dla ${name} (${uid}):`,''); if(!pass){ showUser({}); return; }
        CFG.user={uid,name}; persist(); showUser();
      };
    }

    // --- init buttons
    function initNotesPlans(){
      $('#addNote').onclick=async()=>{
        const v=$('#noteInput').value.trim(); if(!v) return;
        let status='FINAL';
        if(isAdmin()){
          const code=prompt('Podaj kod (0..1000) aby opublikowaƒá do ‚Äûchat‚Äù. B≈Çƒôdny -> DRAFT:','');
          const n = parseInt(code,10);
          if(!(n>=0 && n<=1000) || n!==ADMIN_PASS){
            status='DRAFT';
          } else {
            status='FINAL';
            chatPush(v);
          }
        }
        NOTES.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v, status});
        $('#noteInput').value=''; await saveNotes(); renderNotes();
      };
      $('#addPlan').onclick=async()=>{
        const v=$('#planInput').value.trim(); if(!v) return;
        PLANS.push({id:Date.now()+Math.random(), ts:Date.now(), user:CFG.user.uid, userName:CFG.user.name, text:v});
        $('#planInput').value=''; await savePlans(); renderPlans();
      };
      $('#refreshNP').onclick=async()=>{ await loadNotes(); await loadPlans(); };
      loadNotes(); loadPlans();
    }

    // --- machines render
    function initMachines(){ const box=$('#machines'); box.innerHTML=''; (CFG.machines||[]).forEach(m=> new Machine(box,m, CFG.orders||{})); }

    function init(){ initMachines(); initLogin(); initNotesPlans(); setStatus('gotowy'); }
    init();
  </script>
</body>
</html>
